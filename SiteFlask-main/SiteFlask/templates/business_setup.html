{% extends "base.html" %}

{% block title %}–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <input type="hidden" id="js-vk-account-id" value="{{ selected_account_id }}">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary text-white p-4">
                    <h3 class="mb-1"><i class="fas fa-rocket me-2"></i>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞</h3>
                    <p class="mb-0 opacity-75">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ VK –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –±–∏–∑–Ω–µ—Å–µ</p>
                </div>
                <div class="card-body p-4">
                    <form method="POST" id="setupForm">
                        <h5 class="mb-3 text-primary"><i class="fab fa-vk me-2"></i>–®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –í–ö–æ–Ω—Ç–∞–∫—Ç–µ</h5>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label">ID –≥—Ä—É–ø–ø—ã</label>
                                <input type="text" class="form-control" name="group_id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</label>
                                <input type="text" class="form-control" name="group_name" placeholder="–ú–æ–π –±–∏–∑–Ω–µ—Å">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Access Token (–ö–ª—é—á –¥–æ—Å—Ç—É–ø–∞)</label>
                            <input type="password" class="form-control" name="access_token" placeholder="vk1.a.your_token..." required>
                        </div>

                        <hr class="my-4">

                        <h5 class="mb-3 text-primary"><i class="fas fa-list-check me-2"></i>–®–∞–≥ 2: –û–ø—Ä–æ—Å –æ –±–∏–∑–Ω–µ—Å–µ</h5>
                        
                        <div class="mb-3">
                            <label class="form-label">–ù–∏—à–∞ (–ß—Ç–æ –≤—ã –ø—Ä–æ–¥–∞—ë—Ç–µ?)</label>
                            <input type="text" class="form-control" name="niche" placeholder="–ê–≤—Ç–æ—Ä—Å–∫–∏–µ —Ç–æ—Ä—Ç—ã, —é—Ä–∏–¥–∏—á–µ—Å–∫–∏–µ —É—Å–ª—É–≥–∏...">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">–¶–µ–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</label>
                            <input type="text" class="form-control" name="goals" placeholder="–£–≤–µ–ª–∏—á–µ–Ω–∏–µ –æ—Ö–≤–∞—Ç–æ–≤, –ø—Ä–æ–¥–∞–∂–∏...">
                        </div>

                        <div class="mb-3">
                            <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ –±–∏–∑–Ω–µ—Å–∞ / –£–¢–ü</label>
                            <textarea class="form-control" name="description" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã..."></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">–°—Ç–æ–ø-—Å–ª–æ–≤–∞ (—Ç–æ, –æ —á–µ–º –Ω–µ –ø–∏—Å–∞—Ç—å)</label>
                            <textarea class="form-control" name="stop_words" rows="4" placeholder="–û–ø–∏—à–∏—Ç–µ –≤–∞—à–∏ —Å–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã..."></textarea>
                        </div>

                        <div class="d-grid gap-2 mt-5">
                            <button type="submit" class="btn btn-primary btn-lg">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë –∏ –Ω–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="strategyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">ü§ñ –¢–≤–æ—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è SMM-—Å—Ç—Ä–∞—Ç–µ–≥–∏—è –≥–æ—Ç–æ–≤–∞!</h5>
            </div>
            <div class="modal-body">
                <p class="text-muted">–í–æ—Ç, —á—Ç–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª –ò–ò. –≠—Ç–∞ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ –æ—Å–Ω–æ–≤–∞ –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π</p>
                <textarea id="strategyInput" class="form-control" rows="10" style="resize: none;"></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ü–µ—Ä–µ–¥–µ–ª–∞—Ç—å</button>
                <button type="button" class="btn btn-success" onclick="saveConfirmedStrategy()">
                    üöÄ –û–¥–æ–±—Ä–∏—Ç—å –∏ –≤–æ–π—Ç–∏ –≤ –∫–∞–±–∏–Ω–µ—Ç
                </button>
            </div>
        </div>
    </div>
</div>
<script>
document.querySelector('form').addEventListener('submit', async (e) => {
    e.preventDefault(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫—É
    
    const formData = new FormData(e.target);
    const response = await fetch('/business-setup', {
        method: 'POST',
        body: formData
    });
    
    const data = await response.json();
    if (data.status === 'success') {
        // –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –æ–∫–Ω–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ
        document.getElementById('strategyInput').value = data.strategy;
        var myModal = new bootstrap.Modal(document.getElementById('strategyModal'));
        myModal.show();
    }
});

async function saveConfirmedStrategy() {
    const finalStrategy = document.getElementById('strategyInput').value;
    const confirmBtn = document.querySelector('button[onclick="saveConfirmedStrategy()"]');
    
    confirmBtn.disabled = true;
    confirmBtn.innerText = "‚åõ –ü–ª–∞–Ω–∏—Ä—É–µ–º –ø–æ—Å—Ç—ã...";

    // –®–∞–≥ 1: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—Å—Ç —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
    const saveRes = await fetch('/save-confirmed-strategy', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ strategy: finalStrategy })
    });
    window.location.href = '/unified-dashboard';
   
}
</script>
{% endblock %}