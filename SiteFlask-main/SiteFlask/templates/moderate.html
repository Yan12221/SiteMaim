{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">üìã –ú–æ–¥–µ—Ä–∞—Ü–∏—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h2>
    <div class="row" id="posts-container">
        {% for post in posts %}
        <div class="col-md-4 mb-4" id="card-{{ post.id }}">
            <div class="card h-100 shadow-sm">
                {% if post.image_url %}
                <img src="{{ post.image_url }}" class="card-img-top" alt="Post Image" style="height: 200px; object-fit: cover;">
                {% endif %}
                
                <div class="card-body">
                    <h5 class="card-title">{{ post.title }}</h5>
                    <p class="card-text small text-muted">{{ post.text[:150] }}...</p>
                    
                    <div class="alert alert-light border">
                        <small>üìÖ –ü–ª–∞–Ω: {{ post.publish_date.strftime('%d.%m.%Y –≤ %H:%M') }}</small>
                    </div>
                </div>
                
                <div class="card-footer bg-white border-top-0 d-flex justify-content-between">
                    <button onclick="rejectPost({{ post.id }})" class="btn btn-outline-danger btn-sm">
                        ‚ùå –£–¥–∞–ª–∏—Ç—å
                    </button>
                    <button onclick="approvePost({{ post.id }})" class="btn btn-success btn-sm">
                        ‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12 text-center py-5">
            <h4 class="text-muted">–ù–µ—Ç –ø–æ—Å—Ç–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É üéâ</h4>
            <a href="/unified-dashboard" class="btn btn-primary mt-3">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–µ</a>
        </div>
        {% endfor %}
    </div>
</div>

<script>
async function approvePost(id) {
    const btn = document.querySelector(`#card-${id} .btn-success`);
    btn.disabled = true;
    btn.innerText = "‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...";

    const res = await fetch(`/api/approve-post/${id}`, {method: 'POST'});
    const data = await res.json();

    if (data.success) {
        // –£–±–∏—Ä–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –∫—Ä–∞—Å–∏–≤–æ
        document.getElementById(`card-${id}`).remove();
    } else {
        alert("–û—à–∏–±–∫–∞ VK: " + data.error);
        btn.disabled = false;
        btn.innerText = "‚úÖ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å";
    }
}

async function rejectPost(id) {
    if(!confirm("–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?")) return;
    
    const res = await fetch(`/api/reject-post/${id}`, {method: 'POST'});
    if (res.ok) {
        document.getElementById(`card-${id}`).remove();
    }
}
</script>
{% endblock %}