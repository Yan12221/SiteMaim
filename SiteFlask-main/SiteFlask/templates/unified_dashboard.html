{% extends "base.html" %}

{% block title %}–ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏{% endblock %}

{% block content %}
<body class="{{ 'dark-mode' if current_user.theme_mode == 'dark' else '' }}">
    <div class="container-fluid">
        <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <input type="hidden" id="js-vk-account-id" value="{{ selected_account_id }}">
                        <h1 class="display-6 fw-bold mb-2">üìä –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</h1>
                        <p class="text-muted mb-0">–°–≤–æ–¥–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –≤—Å–µ–º –≤–∞—à–∏–º –∞–∫–∫–∞—É–Ω—Ç–∞–º –∏ –∫–∞–º–ø–∞–Ω–∏—è–º</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            {% if charts.audience_chart %}
                <img src="data:image/png;base64,{{ charts.audience_chart }}" alt="Audience Chart" class="img-fluid">
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-pie fa-3x text-muted mb-3"></i>
                    <p class="text-muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö</p>
                </div>
            {% endif %}
        </div>
        <!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-0 bg-primary bg-gradient text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-2">–ê–∫—Ç–∏–≤–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç—ã</h6>
                                <h2 class="mb-0">{{ stats.total_accounts }}</h2>
                            </div>
                            <div class="icon-circle bg-white bg-opacity-25">
                                <i class="fas fa-users fa-lg"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-white-75">–í—Å–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –≥—Ä—É–ø–ø VK</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card border-0 bg-success bg-gradient text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-2">–û–±—â–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</h6>
                                <h2 class="mb-0">{{ stats.total_followers|number_format }}</h2>
                            </div>
                            <div class="icon-circle bg-white bg-opacity-25">
                                <i class="fas fa-user-friends fa-lg"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-white-75">–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤ –≤–æ –≤—Å–µ—Ö –≥—Ä—É–ø–ø–∞—Ö</small>
                        </div>
                    </div>
                </div>
            </div>
        
            <div class="col-md-3 mb-3">
                <div class="card border-0 bg-info bg-gradient text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-2">–û–±—â–∏–π –æ—Ö–≤–∞—Ç</h6>
                                <h2 class="mb-0">{{ stats.total_reach|number_format }}</h2>
                            </div>
                            <div class="icon-circle bg-white bg-opacity-25">
                                <i class="fas fa-bullseye fa-lg"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-white-75">–ó–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-3 mb-3">
                <div class="card border-0 bg-warning bg-gradient text-white h-100">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="card-title text-white-50 mb-2">–°—Ä–µ–¥–Ω–∏–π CTR</h6>
                                <h2 class="mb-0">{{ stats.avg_ctr }}%</h2>
                            </div>
                            <div class="icon-circle bg-white bg-opacity-25">
                                <i class="fas fa-chart-line fa-lg"></i>
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-white-75">–ö–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∫–ª–∏–∫–æ–≤</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ì—Ä–∞—Ñ–∏–∫–∏ -->
        <div class="row mb-4">
            <div class="col-lg-8 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0"><i class="fas fa-chart-line text-primary me-2"></i>–î–∏–Ω–∞–º–∏–∫–∞ —Ä–æ—Å—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        <img src="data:image/png;base64,{{ charts.growth_chart }}" alt="Growth Chart" class="img-fluid">
                    </div>
                </div>
            </div>

            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0"><i class="fas fa-user-tag text-success me-2"></i>–ü–æ—Ä—Ç—Ä–µ—Ç –∞—É–¥–∏—Ç–æ—Ä–∏–∏</h5>
                    </div>
                    <div class="card-body">
                        {% if charts.audience_chart %}
                            <img src="data:image/png;base64,{{ charts.audience_chart }}" alt="Audience Chart" class="img-fluid">
                        {% else %}
                            <div class="text-center py-5">
                                <i class="fas fa-users-slash fa-3x text-muted mb-3"></i>
                                <p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∏–∂–Ω–∏–π —Ä—è–¥ -->
        <div class="row">
            <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏ -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-rocket text-danger me-2"></i>–ê–∫—Ç–∏–≤–Ω—ã–µ –∫–∞–º–ø–∞–Ω–∏–∏</h5>
                        <span class="badge bg-primary">{{ campaigns|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if campaigns %}
                        <div class="list-group list-group-flush">
                            {% for campaign in campaigns %}
                            <div class="list-group-item border-0 px-0 py-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">{{ campaign.name }}</h6>
                                        <small class="text-muted">{{ campaign.theme }}</small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if campaign.status == 'active' else 'secondary' }}">
                                        {{ campaign.status }}
                                    </span>
                                </div>
                                <div class="mb-2">
                                    <small class="text-muted">–ü—Ä–æ–≥—Ä–µ—Å—Å: {{ campaign.progress }}%</small>
                                    <div class="progress" style="height: 6px;">
                                        <div class="progress-bar bg-{{ 'success' if campaign.status == 'active' else 'secondary' }}" 
                                            style="width: {{ campaign.progress }}%">
                                        </div>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>{{ campaign.total_reach|number_format }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-heart me-1"></i>{{ campaign.total_engagement|number_format }}
                                    </small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                            <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–π</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –¢–æ–ø –ø–æ—Å—Ç–æ–≤ -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-crown text-warning me-2"></i>–¢–æ–ø –ø–æ—Å—Ç–æ–≤</h5>
                        <span class="badge bg-warning text-dark">–¢–æ–ø-{{ top_posts|length }}</span>
                    </div>
                    <div class="card-body">
                        {% if top_posts %}
                        <div class="list-group list-group-flush">
                            {% for post in top_posts %}
                            <div class="list-group-item border-0 px-0 py-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 text-truncate" style="max-width: 70%;" title="{{ post.type|title }} –ø–æ—Å—Ç">
                                        {{ post.text }}
                                    </h6>
                                    <span class="badge bg-info">{{ post.engagement_score }} –æ—á–∫–æ–≤</span>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <small class="text-muted">
                                        <i class="fas fa-heart text-danger me-1"></i>{{ post.likes }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-comment text-primary me-1"></i>{{ post.comments }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-share text-success me-1"></i>{{ post.shares }}
                                    </small>
                                    <small class="text-muted">
                                        <i class="fas fa-eye me-1"></i>{{ post.reach }}
                                    </small>
                                </div>
                                <small class="text-muted d-block">
                                    <i class="fas fa-clock me-1"></i>{{ post.published_time|format_date }}
                                </small>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                            <p class="text-muted">–ù–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- –ì—Ä–∞—Ñ–∏–∫ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ -->
            <div class="col-lg-4 mb-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0">
                        <h5 class="mb-0"><i class="fas fa-chart-bar text-info me-2"></i>–≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç–∞</h5>
                    </div>
                    <div class="card-body">
                        {% if charts.engagement_chart %}
                        <img src="{{ charts.engagement_chart }}" alt="Engagement Chart" class="img-fluid">
                        {% else %}
                        <div class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <p class="text-muted">–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ru.js'></script>

            <div class="card border-0 shadow-sm mt-4">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0"><i class="fas fa-calendar-alt text-primary me-2"></i>–ö–æ–Ω—Ç–µ–Ω—Ç-–ø–ª–∞–Ω</h5>
                </div>
            </div>
            <div class="card-body">
                <div id='calendar'></div>
            </div>
        </div>
        <div class="text-center py-5">
            <button onclick="fetchFromVKAPI()" class="btn btn-primary">
                <i class="fas fa-sync"></i> –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ VK
            </button>
        </div>
      
    </div>   
</body>

{% endblock %}

{% block scripts %}
<script>

// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∫–∞–∂–¥—ã–µ 60 —Å–µ–∫—É–Ω–¥
function updateDashboard() {
    fetch('/api/unified-stats')
        .then(response => {
            if (!response.ok) throw new Error('Not found');
            return response.json();
        })
        .then(data => {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ID –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ)
            const updateEl = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.innerText = value.toLocaleString();
            };

            updateEl('total-reach', data.total_reach || 0);
            updateEl('total-likes', data.total_likes || 0);
            updateEl('total-posts', data.total_posts || 0);
            updateEl('total-accounts', data.total_accounts || 0);
        })
        .catch(err => console.warn('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–∫–∞ –Ω–µ –¥–æ—Å—Ç—É–ø–Ω–∞:', err));
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', updateDashboard);

function formatNumber(num) {
    return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

// –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
setInterval(updateDashboard, 60000);

// –ü–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
setTimeout(updateDashboard, 5000);

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ru', // –†—É—Å—Å–∫–∏–π —è–∑—ã–∫
        firstDay: 1,  // –ù–µ–¥–µ–ª—è –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: '/api/calendar-posts', // –°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞—à API –∏–∑ —à–∞–≥–∞ 1
        
        eventClick: function(info) {
            if (info.event.url) {
                window.location.href = info.event.url;
                info.jsEvent.preventDefault();
            }
        },
        // –ö—Ä–∞—Å–∏–≤–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        eventTimeFormat: { 
            hour: '2-digit',
            minute: '2-digit',
            meridiem: false
        }
    });
    
    calendar.render();
});
const themeToggle = document.getElementById('theme-toggle');
if (themeToggle) { // <--- –î–û–ë–ê–í–ò–¢–¨ –≠–¢–£ –ü–†–û–í–ï–†–ö–£
    const body = document.body;
    const icon = themeToggle.querySelector('i');

    themeToggle.addEventListener('click', () => {
       const isDark = body.classList.toggle('dark-mode');
        const themeName = isDark ? 'dark' : 'light';
        
        // –ú–µ–Ω—è–µ–º –∏–∫–æ–Ω–∫—É –Ω–∞ –ª–µ—Ç—É
        if (isDark) {
            icon.classList.replace('fa-moon', 'fa-sun');
        } else {
            icon.classList.replace('fa-sun', 'fa-moon');
        }
        
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –±–∞–∑—É
        fetch('/api/save-theme', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ theme: themeName })
        }).then(res => {
            if (!res.ok) console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç–µ–º—É –≤ –ë–î");
        });
    });
}

function fetchFromVKAPI() {
    // 1. –ë–µ—Ä–µ–º ID –∏–∑ —Å–∫—Ä—ã—Ç–æ–≥–æ –ø–æ–ª—è
    const accountIdField = document.getElementById('js-vk-account-id');
    const currentAccountId = accountIdField ? accountIdField.value : null;

    if (!currentAccountId || currentAccountId === 'None') {
        alert('–ù–µ –≤—ã–±—Ä–∞–Ω –∞–∫–∫–∞—É–Ω—Ç VK –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è!');
        return;
    }
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∑–∞–≥—Ä—É–∑–∫–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å –º–æ–¥–∞–ª–∫–∞ loadingModal)
    // –ï—Å–ª–∏ –º–æ–¥–∞–ª–∫–∏ –Ω–µ—Ç, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ –∏–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏
    const btn = document.querySelector('button[onclick="fetchFromVKAPI()"]');
    if(btn) {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-sync fa-spin"></i> –û–±–Ω–æ–≤–ª—è–µ–º...';
    }
    
    // 2. –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å –∫ –Ω–∞—à–µ–º—É –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–º—É API
    fetch(`/api/vk/fetch/${currentAccountId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏–∑ VK!\n' + data.message);
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å –Ω–æ–≤—ã–µ —Ü–∏—Ñ—Ä—ã
            location.reload(); 
        } else {
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: ' + (data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
        }
    })
    .catch(error => {
        console.error(error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º');
    })
    .finally(() => {
        if(btn) {
            btn.disabled = false;
            btn.innerHTML = '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ VK';
        }
    });
}
</script>
{% endblock %}